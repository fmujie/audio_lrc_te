<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="./CSS/500ios.css" rel="stylesheet" type="text/css" media="all"/>
    <link href="./CSS/audioPlay.css" rel="stylesheet" type="text/css" media="all"/>
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/popper.js/1.15.0/umd/popper.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <style>
        
    </style>
</head>
<body>
    
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModal">
        打开模态框
    </button>
    <!-- Lrc模态框 -->
    <div class="modal fade" id="myModal" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-lg">
        <div class="modal-content">
    
            <!-- 模态框头部 -->
            <div class="modal-header">
                <button class="btn btn-primary mr-1" id="spile-btn">分词</button>
                <!-- <button class="btn btn-success mr-1" id="fin-btn">保存</button> -->
                <button type="button" id="reload-btn" class="btn btn-primary mr-1">Reload</button>
                <button type="button" id="tag-btn" class="btn btn-primary mr-1">Tag</button>
                <button onclick="writing()" type="button" id="tag-btn" class="btn btn-primary mr-1">Preview</button>
                
                <canvas id="canvas" style="height: 37px; width: 150px;"></canvas>
                <audio id="audio-element" style="opacity: 0.5;">
                    <source src="audio/newboy.mp3" type="audio/mpeg">
                </audio>
                  
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
    
            <!-- 模态框主体 -->
            <div class="modal-body d-flex justify-content-around bg-secondary">
                <div class="text-container row">
                    <div style="text-align: center;">
<pre class="form-control" id="music-text" style="width: 300px; height: 360px;" id="comment" readonly="readonly">穿新衣吧 
剪新发型呀 
轻松一下 Wds98 
打扮漂亮 
18岁是天堂 
我们的生活 
甜得像糖 
穿新衣吧 
剪新发型呀 
轻松一下 Wds98 
以后的路不再会有痛苦 
我们的未来该有多酷</pre>
                    </div>
                </div>
                <div class="terminal-window" style="width: 350px;">
                    <header>
                        <div class="button green"  id="button"></div>
                        <div class="button yellow"></div>
                        <div class="button red"></div>
                    </header>
                    <section class="terminal" id="lrc_list">
                        <div class="history"></div>
                        <!-- $&nbsp;<span class="prompt"></span> -->
                        <span class="typed-cursor"></span>
                        <div id="lrc_text" class="bg-dark"></div>
                    </section>
                </div>
            </div>
    
            <!-- 模态框底部 -->
            <div class="modal-footer d-flex justify-content-between">
                <div>
                    <span class="badge badge-light">Coded by <a href="https://github.com/fmujie" target="_blank" class="alert-link">fmujie</a> && <a href="https://github.com/github-power" target="_blank" class="alert-link">github-power</a></span>
                </div>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
            </div>
    
        </div>
        </div>
    </div>
    <script>
        let index = 0
        let textArr = null
        let textArrIndex = 0;  
        let musicArr = []
        let lrcArr = []
        let lyrics = []
        let currentTime = null
        let pattern1 = new RegExp("[0-9]+");  // 判断是否为数字
        let pattern2 = new RegExp("[A-Za-z]+");  // 判断是否为英文
        let musicTextDom = document.getElementById('music-text')
        let terminalDom = document.getElementsByClassName('terminal-window')
        // let finBtn = document.getElementById('fin-btn')
        let spileBtn = document.getElementById('spile-btn')
        let tagBtn = document.getElementById('tag-btn')
        let reloadBtn = document.getElementById('reload-btn')
        let audio = document.getElementById('audio-element');
        
        reloadBtn.onclick = function () {
            index = 0;  // reset index
            lrcArr = []  // clear array
            if (audio.paused || audio.play) {
                audio.load();
                audio.play()
            }
            elements = $('p')
            elementsLength = elements.length
            for (let i = elementsLength; i > 0; i--) {
                elements[i - 1].remove()
            }
        }
        
        $('audio').bind('ended', function(){
            console.log('ended')
            console.log(lrcArr)  // get array
            lyrics = parseLyrics(lrcArr)
            console.log(lyrics)
        })

        function insertAfter(newElement, targetElement){ // newElement是要追加的元素targetElement 是指定元素的位置
            var parent = targetElement.parentNode; // 找到指定元素的父节点
            parent.appendChild(newElement, targetElement);
        };

        tagBtn.onclick = function () {
            currentTime = audio.currentTime.toFixed(2)
            let m = parseInt(currentTime / 60 % 60).toString()
            let s = parseInt(currentTime % 60).toString()
            let ms = (currentTime % 60).toFixed(2).toString().slice(-2)
            m.length != 2 ? m = '0' + m : m
            s.length != 2 ? s = '0' + s : s
            // console.log('[' + m + ':' + s + '.' + ms + '] ' + musicArr[index]);  // 调试用
            typeof(musicArr[index]) == 'string' ? lrcArr.push('[' + m + ':' + s + '.' + ms + '] ' + musicArr[index++]) : null
            var p = document.createElement("p") // create pelement
            p.classList.add("text-white")
            p.classList.add("mb-1")
            p.setAttribute('disabled', true)
            p.innerHTML = '$ ' + lrcArr[index - 1]  // lrcArr中值存放到P标签内
            console.log(lrcArr[index - 1])
            var header = document.getElementById('lrc_text')
            insertAfter(p, header)  //将 p标签添加到lrc_text div中
            $('#lrc_list').scrollTop( $('#lrc_list')[0].scrollHeight);
        }

        spileBtn.addEventListener("click",()=>{
            console.log(musicTextDom.innerHTML)
            textarr = musicTextDom.innerHTML.replace(/\n/g,"<br>").replace(/\s*/g,"").split('')
            // console.log(textarr)  // 调试用
            let i = 0
            let j = 0
            let k = 0
            let m = null
            while(i < textarr.length){
                if (textarr[i] == '<'){
                    musicArr[k - 1] = musicArr[k-1] + '<br>'
                    i += 4
                } else {
                    if (isEnOrNum(textarr[i])) {
                        m = i
                        while (isEnOrNum(textarr[++i])) {
                            textarr[m] += textarr[i]
                        }
                        // console.log(i, m, k, textarr[m])  // 调试用
                        musicArr[k++] = textarr[m]
                    } else {
                        musicArr[k++] = textarr[i++]
                    }
                }
            }

            musicTextDom.innerHTML = musicArr.join("\n")
            musicArr = musicTextDom.innerHTML.split("\n")
            console.log(musicArr);  // 调试用以查看打点后的lrc格式的music歌词数组
            disbtn(spileBtn)
        })
        /**
         *  判读字符时候为英文或 数字
         * returns {boolean} result, true or false
         */
        function isEnOrNum (str) {
            if (pattern1.test(str) || pattern2.test(str)) {
                return true
            } else {
                return false
            }
        }
        
        /**
         *  @param {Array}
         * return {Array} lrc解析后的应用数组
         */
        function parseLyrics(lrc) {
            let lyrics = [];
            for (let i = 0; i < lrc.length; i++) {
                let line = lrc[i];
                let time = line.substring(1,9);
                let text = line.substring(11);
                let minutes = parseInt(time.substring(0,2));
                let seconds = parseInt(time.substring(3,5));
                let milliseconds = parseInt(time.substring(6,9));
                let timestamp = minutes * 60 * 1000 + seconds * 1000 + milliseconds;
                lyrics.push({time: timestamp, text: text});
            }
            return lyrics;
        }
        // 0  1  2  3  4
        // a  b  c  d  e
        // 1  3  6  8  10
        let index0 = 0
        function writing() {
            audio.play()
            if (!index0) {
                interval = lyrics[index0].time
                musicTextDom.innerHTML = ''
            } else {
                musicTextDom.innerHTML += lyrics[index0 - 1].text
                console.log(lyrics[index0 - 1].text)
                if (index0 < lyrics.length) {
                    interval = lyrics[index0].time - lyrics[index0 - 1].time
                } else {
                    console.log('结束')
                    index0 = 0
                    return 0
                }
            }
            setTimeout(writing.bind(this), interval, ++index0);
        }

        function disbtn(element)
        {
            console.log(element)
            element.setAttribute('disabled', true)
            element.classList.remove('btn-primary')
            element.classList.add('btn-secondary')
        }
    </script>
    <script>
        // 获取音频上下文和音频元素
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const audioElement = document.getElementById('audio-element');

        // 创建音频源和分析器节点
        const audioSource = audioCtx.createMediaElementSource(audioElement);
        const analyser = audioCtx.createAnalyser();

        // 将分析器连接到音频源和输出节点
        audioSource.connect(analyser);
        analyser.connect(audioCtx.destination);

        // 设置分析器参数
        analyser.fftSize = 2048;
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);

        // 获取画布和上下文
        const canvas = document.getElementById('canvas');
        const canvasCtx = canvas.getContext('2d');

        // 绘制函数
        function draw() {
            requestAnimationFrame(draw);

            // 将音频数据复制到dataArray中
            analyser.getByteFrequencyData(dataArray);

            // 清空画布并设置颜色
            canvasCtx.fillStyle = 'rgb(255, 255, 255)';
            canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

            // 设置柱状图的参数
            const barWidth = (canvas.width / bufferLength) * 2.5;
            let barHeight;
            let x = 0;

            // 循环遍历dataArray并绘制柱状图
            for (let i = 0; i < bufferLength; i++) {
                barHeight = dataArray[i];

                canvasCtx.fillStyle = `rgb(${barHeight},50,50)`;
                canvasCtx.fillRect(x, canvas.height - barHeight / 2, barWidth, barHeight / 2);

                x += barWidth + 1;
            }
        }
        // 开始绘制
        draw();
    </script>
    </script>
</body>
</html>